const gulp = require("gulp"),
      path = require('path'),
      sass = require('gulp-sass'),
      autoprefixer = require('gulp-autoprefixer'),
      cssmin = require('gulp-cssmin'),
      typescript = require('gulp-typescript'),
      plumber = require('gulp-plumber'),
      rename = require("gulp-rename"),
      watch = require('gulp-watch'),
      uglify = require('gulp-uglify'),
      concat = require('gulp-concat'),
      del = require('del'),
      runSequence = require('run-sequence'),
      browserSync = require("browser-sync"),
      browserify = require('browserify'),
      source = require('vinyl-source-stream');

/**
 * File Path
 */
// src
const ROOT           = __dirname;
const SRC_PATH       = path.join(ROOT, './src');
const DIST_PATH      = path.join(ROOT, './dist');

const SCSS_SRC_PATH  = path.join(SRC_PATH, 'scss');
const SCSS_SRC_FILES = path.join(SCSS_SRC_PATH, './**/*.scss');
const JS_SRC_PATH    = path.join(SRC_PATH, 'js');
const JS_SRC_FILES   = path.join(JS_SRC_PATH, './**/*.js');

// docs
const DOCS_PATH      = path.join(ROOT, './docs');
const CSS_DOCS_PATH  = path.join(DOCS_PATH, 'css');
const JS_DIST_FILES  = path.join(DIST_PATH, './**/*.js');


// Sass, CSS
gulp.task('sass', function() {
  return gulp.src(SCSS_SRC_FILES)
    .pipe(sass({
      outputStyle: 'expanded'
    })
    .on('error', sass.logError))
    .pipe(gulp.dest(CSS_DOCS_PATH));
});

// JavaScript
gulp.task('js.min', function() {
  return gulp.src([
    JS_DIST_FILES,
    '!' + DIST_PATH + '/**/*min.js'
  ])
    .pipe(uglify())
    .pipe(rename({
      suffix: '.min'
    }))
    .pipe(gulp.dest(DIST_PATH));
});

function setHeader(req, res, next) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  next();
}

// ファイル更新監視
gulp.task('watch', function() {
  // SCSS
  gulp.watch([SCSS_SRC_FILES], ['build.css']);
});

gulp.task('browser-sync', function() {
  browserSync.init({
    files: [JS_SRC_FILES],
    server: {
      baseDir: "./docs/",
      middleware: function (req, res, next) {
        res.setHeader('Access-Control-Allow-Origin', '*');
        next();
      }
    }
  });

  browserSync.reload();
});

/**
 * Build Task
 **/
gulp.task('dist', function(callback) {
  return runSequence(
    'js.min',
    callback
  );
});

gulp.task('build.css', function(callback) {
  return runSequence(
    'sass',
    callback
  );
});

/**
 * All Task
 **/
gulp.task('default', function(callback) {
  runSequence(
    'build.css',
    'watch',
    'browser-sync',
    callback
  );
});
